<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã“ã„ãƒ•ãƒ©å¨¯æ¥½å±‹ - ONLINE</title>
    <style>
        :root { --gold: #ffd700; --numa: #39ff14; --pink: #ff007f; --bg: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 12px 15px; background: #000; border-bottom: 2px solid var(--numa); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        #display-name { color: var(--numa); font-weight: bold; font-size: 18px; }
        .currency { font-weight: bold; font-size: 16px; color: var(--gold); }
        #view { flex: 1; position: relative; width: 100%; overflow: hidden; }
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; padding: 15px; overflow-y: auto; }
        .screen.active { display: flex; }
        .btn { padding: 12px; border-radius: 10px; border: none; background: #333; color: white; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--numa); color: #000; width: 95%; margin-top: 10px; }
        input { background: #111; color: white; border: 1px solid #444; padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; width: 100%; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #machine { width: 95vw; height: 320px; max-width: 400px; background: #222; border: 4px solid #444; position: relative; overflow: hidden; border-radius: 15px; }
        #hole { position: absolute; left: 0; bottom: 0; width: 65px; height: 30px; background: #000; }
        #unit { position: absolute; top: 0; width: 50px; display:flex; flex-direction:column; align-items:center; z-index:10; }
        #wire { width: 4px; height: 30px; background: #aaa; }
        #claw { width: 50px; height: 15px; background: var(--pink); position: relative; border-radius: 5px; }
        .arm { width: 8px; height: 30px; background: #eee; position: absolute; top: 10px; transition: 0.3s; transform-origin: top; }
        .arm.L { left: 5px; transform: rotate(40deg); } .arm.R { right: 5px; transform: rotate(-40deg); }
        .pz { position: absolute; bottom: 10px; font-size: 25px; width: 30px; text-align: center; }
        nav { display: flex; background: #000; border-top: 2px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; background: none; border: none; color: #666; font-size: 10px; padding: 12px 0; }
        .nav-btn.active { color: var(--numa); }
        .nav-btn span { font-size: 18px; display: block; }
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; align-items: center; justify-content: center; }
        #toast { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: var(--numa); color: #000; padding: 10px 20px; border-radius: 50px; display: none; z-index: 30000; font-weight: bold; }
    </style>
</head>
<body>
<header><div id="display-name">æ¥ç¶šä¸­...</div><div class="currency">ğŸª™ <span id="c-v">0</span></div></header>
<div id="view">
    <div id="scr-pachi" class="screen active"><canvas id="p-cvs" width="350" height="380"></canvas><button class="btn btn-main" onclick="shootPachi()">æ‰“ã¡å‡ºã— (5æš)</button></div>
    <div id="scr-crane" class="screen"><div id="machine"><div id="hole"></div><div id="unit" style="left:150px;"><div id="wire"></div><div id="claw"><div class="arm L" id="armL"></div><div class="arm R" id="armR"></div></div></div><div id="p-con"></div></div><div style="display:flex; gap:10px; margin-top:10px; width:95%;"><button class="btn" style="width:60px;" onmousedown="mvL=1" onmouseup="mvL=0" ontouchstart="mvL=1" ontouchend="mvL=0">â—€</button><button class="btn btn-main" onclick="playCrane()" style="flex:1; margin:0;">CATCH (50æš)</button><button class="btn" style="width:60px;" onmousedown="mvR=1" onmouseup="mvR=0" ontouchstart="mvR=1" ontouchend="mvR=0">â–¶</button></div></div>
    <div id="scr-race" class="screen"><div id="track" style="width:100%; height:180px; background:#1a4a1a; position:relative;"><div id="h1" class="horse" style="top:10px; position:absolute;">ğŸ´</div><div id="h2" class="horse" style="top:50px; position:absolute;">ğŸ¦„</div><div id="h3" class="horse" style="top:90px; position:absolute;">ğŸº</div><div id="h4" class="horse" style="top:130px; position:absolute;">ğŸ‚</div></div><input id="r-bet-am" type="number" placeholder="è³­ã‘é‡‘" style="width:95%; margin:10px 0;"><div style="display:flex; gap:5px; width:95%;"><button class="btn" onclick="selH(1)" id="b-btn-1" style="flex:1;">1</button><button class="btn" onclick="selH(2)" id="b-btn-2" style="flex:1;">2</button><button class="btn" onclick="selH(3)" id="b-btn-3" style="flex:1;">3</button><button class="btn" onclick="selH(4)" id="b-btn-4" style="flex:1;">4</button></div><button class="btn btn-main" id="r-go" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button></div>
    <div id="scr-shop" class="screen"><div id="ranking-list" style="width:100%; background:#111; padding:10px; border-radius:10px;"></div><div id="shop-items" style="width:100%; margin-top:10px;"></div></div>
    <div id="scr-chat" class="screen"><div id="chat-box" style="width:100%; height:250px; background:#111; padding:10px; overflow-y:auto; border-radius:10px;"></div><div style="display:flex; width:100%; gap:5px; margin-top:10px;"><input id="chat-in" style="flex:1;" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..."><button class="btn" onclick="sendChat()">é€ä¿¡</button></div></div>
</div>
<nav><button class="nav-btn active" onclick="tab('pachi', event)"><span>ğŸ°</span>æ²¼</button><button class="nav-btn" onclick="tab('crane', event)"><span>ğŸ—ï¸</span>ã‚¯ãƒ¬ãƒ¼ãƒ³</button><button class="nav-btn" onclick="tab('race', event)"><span>ğŸ‡</span>ç«¶é¦¬</button><button class="nav-btn" onclick="tab('shop', event)"><span>ğŸ›’</span>åº—</button><button class="nav-btn" onclick="tab('chat', event)"><span>ğŸ’¬</span>è«‡è©±</button></nav>
<div id="login-screen"><div style="text-align:center; padding:30px; background:#111; border:3px solid var(--numa); border-radius:25px; width:90%;"><h2 style="color:var(--numa);">ã“ã„ãƒ•ãƒ©å¨¯æ¥½å±‹</h2><input type="text" id="u-in" placeholder="ãªã¾ãˆã‚’å…¥åŠ›" style="width:100%; text-align:center;"><br><button class="btn btn-main" style="margin-top:20px;" onclick="reg()">å…¥åº—</button></div></div>
<div id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    const firebaseConfig = {
        apiKey: "AIzaSyCU2bYxI1GLvNIvektBxDIMn63oRBpxYeY",
        authDomain: "papa3papas-bu-pu.firebaseapp.com",
        databaseURL: "https://project-3532912589484644114-default-rtdb.firebaseio.com",
        projectId: "project-3532912589484644114",
        storageBucket: "project-3532912589484644114.firebasestorage.app",
        messagingSenderId: "1042501104691",
        appId: "1:1042501104691:web:79c37b2e8c6e6544c8df46"
    };
    const app = initializeApp(firebaseConfig); const db = getDatabase(app);
    window.Sys = {
        db, user: null,
        reg: async (name) => {
            const userRef = ref(db, 'users/' + name); const snap = await get(userRef);
            if (snap.exists()) { window.Sys.user = snap.val(); }
            else { window.Sys.user = { name: name, coins: 1000, inv: ["ãªã—"] }; await set(userRef, window.Sys.user); }
            window.startApp();
        },
        save: () => { if (window.Sys.user) { set(ref(db, 'users/' + window.Sys.user.name), window.Sys.user); window.upUI(); } },
        add: (am) => { window.Sys.user.coins += Number(am); window.Sys.save(); },
        sub: (am) => { if (window.Sys.user.coins >= am) { window.Sys.user.coins -= am; window.Sys.save(); return true; } return false; },
        sendChat: (msg) => { push(ref(db, 'chats'), { n: window.Sys.user.name, m: msg, t: Date.now() }); }
    };
    onValue(ref(db, 'chats'), (snap) => {
        const data = snap.val(); if (data) {
            const list = Object.values(data).sort((a,b) => a.t - b.t).slice(-30);
            document.getElementById('chat-box').innerHTML = list.map(c => `<div><b style="color:var(--numa)">${c.n}:</b> ${c.m}</div>`).join('');
            document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
        }
    });
</script>
<script>
    let mvL=0, mvR=0, cX=150, busy=false, bHorse=0;
    const $ = id => document.getElementById(id);
    function reg() { const n=$('u-in').value.trim(); if(n) window.Sys.reg(n); }
    window.startApp = () => { $('login-screen').style.display='none'; upUI(); spwP(); loop(); };
    window.upUI = () => { if(!window.Sys.user) return; $('c-v').innerText = Math.floor(window.Sys.user.coins); $('display-name').innerText = window.Sys.user.name; };
    const cvs=$('p-cvs'), ctx=cvs.getContext('2d');
    let balls=[], pins=[]; for(let r=0; r<10; r++) for(let c=0; c<8; c++) pins.push({x:35+c*40+(r%2)*20, y:40+r*35});
    function drawP(){ ctx.clearRect(0,0,350,380); ctx.fillStyle='#444'; pins.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,7);ctx.fill();}); balls.forEach((b,i)=>{ b.y+=b.vy; b.vy+=0.25; b.x+=b.vx; pins.forEach(p=>{ let d=Math.hypot(b.x-p.x,b.y-p.y); if(d<12){ b.vx=(b.x-p.x)*0.6; b.vy*=-0.4; }}); if(b.y>350 && b.x>140 && b.x<210){ window.Sys.add(40); balls.splice(i,1); toast("WIN! +40"); } else if(b.y>390) balls.splice(i,1); ctx.fillStyle='#39ff14'; ctx.beginPath(); ctx.arc(b.x,b.y,6,0,7); ctx.fill(); }); }
    function shootPachi(){ if(window.Sys.sub(5)) balls.push({x:175, y:20, vx:Math.random()-0.5, vy:2}); }
    async function playCrane(){
        if(busy || !window.Sys.sub(50)) return; busy=true;
        const w=$('wire'), aL=$('armL'), aR=$('armR'), ut=$('unit'); let hit=null;
        await moveW(w, 30, 260, 4); // ä¸‹é™
        aL.style.transform='rotate(-5deg)'; aR.style.transform='rotate(5deg)';
        document.querySelectorAll('.pz').forEach(p=>{ if(Math.abs(parseInt(p.style.left)-cX-10)<20) hit=p; });
        await new Promise(r=>setTimeout(r,500));
        let failAt = Math.random() < 0.4 ? 150 : -1;
        await new Promise(r=>{
            let s=260; function up(){
                s-=4; w.style.height=s+"px";
                if(hit){ hit.style.bottom=(320-s-45)+"px"; if(failAt!==-1 && s<failAt){ toast("ã‚ã‚ã£ï¼"); aL.style.transform='rotate(40deg)'; aR.style.transform='rotate(-40deg)'; hit.style.bottom="10px"; hit=null; }}
                if(s>30) requestAnimationFrame(up); else r();
            } up();
        });
        if(hit){
            ut.style.transition="left 1.5s"; cX=5; ut.style.left="5px";
            let mvI = setInterval(()=>{ if(hit) hit.style.left=(ut.offsetLeft+10)+"px"; },20);
            await new Promise(r=>setTimeout(r,1500)); clearInterval(mvI);
            aL.style.transform='rotate(40deg)'; aR.style.transform='rotate(-40deg)'; hit.style.bottom="-50px";
            await new Promise(r=>setTimeout(r,600)); hit.remove(); window.Sys.add(250); toast("GET! +250"); spwP();
        } else { ut.style.transition="left 1s"; ut.style.left="5px"; await new Promise(r=>setTimeout(r,1000)); }
        ut.style.transition="none"; busy=false;
    }
    function moveW(el,s,e,st){ return new Promise(r=>{ function f(){ s+=st; el.style.height=s+"px"; if((st>0&&s<e)||(st<0&&s>e)) requestAnimationFrame(f); else r();} f();}); }
    function spwP(){ if($('p-con').children.length==0) for(let i=0;i<4;i++) $('p-con').innerHTML+=`<div class="pz" style="left:${80+i*70}px; bottom:10px;">ğŸ</div>`; }
    function tab(id, e){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $('scr-'+id).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); e.currentTarget.classList.add('active'); }
    function toast(m){ const t=$('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }
    function loop() { if(!busy && $('scr-crane').classList.contains('active')) { if(mvL) cX=Math.max(5,cX-4); if(mvR) cX=Math.min(310,cX+4); $('unit').style.left=cX+"px"; } drawP(); requestAnimationFrame(loop); }
    function sendChat(){ const i=$('chat-in'); if(i.value){ window.Sys.sendChat(i.value); i.value=""; } }
</script>
</body>
</html>
