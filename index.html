<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        body { background: #000; margin: 0; overflow: hidden; color: white; font-family: 'DotGothic16', sans-serif; touch-action: none; }
        #ui { text-align: center; height: 50px; line-height: 50px; font-size: 20px; }
        #hp-bar-ui { width: 150px; height: 20px; background: #c00; display: inline-block; vertical-align: middle; border: 2px solid #fff; position: relative; margin: 0 10px; }
        #hp-fill { height: 100%; background: #ff0; width: 100%; transition: width 0.1s; }
        canvas { display: block; background: #000; margin: 0 auto; border: 2px solid #333; }
        #controls { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #000; }
        .menu-btn { flex: 1; max-width: 100px; padding: 12px 0; border: 3px solid #ff8000; background: #000; color: #ff8000; font-family: 'DotGothic16'; font-weight: bold; font-size: 14px; }
        #joystick { position: fixed; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #fff; visibility: hidden; }
        #stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }
    </style>
</head>
<body onclick="if(isGameOver) initGame()">
    <div id="ui">SANZ LV 19 HP <div id="hp-bar-ui"><div id="hp-fill"></div></div> <span id="hp-text">100/100</span></div>
    <canvas id="gameCanvas"></canvas>
    <div id="controls">
        <button class="menu-btn" onclick="startTurn()">FIGHT</button>
        <button class="menu-btn" onclick="hp=100; startTurn()">ITEM</button>
    </div>
    <div id="joystick"><div id="stick"></div></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
// 描画が崩れないよう解像度を固定
canvas.width = 640; canvas.height = 480;

let hp = 100, phase = 'MENU', timer = 0, isGameOver = false, turn = 0;
let objects = [], soul, lastTime = performance.now(), shake = 0;
const box = { x: 120, y: 220, w: 400, h: 220 }; // 戦闘枠の位置を固定

function initGame() {
    hp = 100; phase = 'MENU'; turn = 0; objects = []; isGameOver = false; timer = 0;
    soul = { x: 320, y: 350, vx: 0, vy: 0, mode: 'BLUE', speed: 4 };
    document.getElementById('joystick').style.visibility = 'hidden';
}

function startTurn() {
    if(isGameOver) return;
    turn++; phase = 'ATTACK'; timer = 0; objects = [];
    soul.mode = (turn % 2 === 0) ? 'RED' : 'BLUE';
    document.getElementById('joystick').style.visibility = 'visible';
}

// ジョイスティック処理
let stickX = 0, stickY = 0;
const js = document.getElementById('joystick');
const st = document.getElementById('stick');
const handleMove = (e) => {
    e.preventDefault(); const r = js.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e;
    const dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
    const d = Math.min(Math.sqrt(dx*dx + dy*dy), 50); const a = Math.atan2(dy, dx);
    stickX = (d > 5) ? Math.cos(a) * (d/50) : 0; stickY = (d > 5) ? Math.sin(a) * (d/50) : 0;
    st.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
};
js.addEventListener('touchstart', handleMove); js.addEventListener('touchmove', handleMove);
js.addEventListener('touchend', () => { stickX = 0; stickY = 0; st.style.transform = `translate(0,0)`; });

function update(dt) {
    if (isGameOver) return;
    if (shake > 0) shake -= dt;

    if (phase === 'ATTACK') {
        timer += dt;

        // 攻撃1: 高速骨
        if (Math.floor(timer) % 35 === 0 && timer < 300) {
            objects.push({ type: 'BONE', x: 640, y: box.y + box.h - 60, w: 20, h: 60, speed: 7 });
        }
        // 攻撃2: 洗濯ブラスター (ターン後半)
        if (timer > 300 && timer < 305 && objects.filter(o=>o.type==='BLASTER').length === 0) {
            for(let i=0; i<4; i++) {
                objects.push({ type: 'BLASTER', x: 320, y: 330, angle: (Math.PI/2)*i, timer: 30, active: false, rot: 0.12 });
            }
        }

        if (timer > 600) { phase = 'MENU'; document.getElementById('joystick').style.visibility = 'hidden'; }

        // ソウル移動
        if (soul.mode === 'RED') {
            soul.vx = stickX * soul.speed * dt;
            soul.vy = stickY * soul.speed * dt;
        } else {
            soul.vx = stickX * soul.speed * dt;
            soul.vy += 0.7 * dt; // 重力
            if (stickY < -0.3 && soul.y >= box.y + box.h - 15) soul.vy = -6 + (stickY * 6);
        }
        soul.x += soul.vx; soul.y += soul.vy;
        soul.x = Math.max(box.x+15, Math.min(box.x+box.w-15, soul.x));
        soul.y = Math.max(box.y+15, Math.min(box.y+box.h-15, soul.y));
        if (soul.y >= box.y + box.h - 15) soul.vy = 0;

        // 当たり判定
        objects.forEach((obj, i) => {
            if (obj.type === 'BONE') {
                obj.x -= obj.speed * dt;
                if (Math.abs(soul.x - obj.x) < 18 && soul.y > obj.y - 5) { hp -= 1.5 * dt; shake = 5; }
            } else if (obj.type === 'BLASTER') {
                obj.angle += obj.rot * dt;
                obj.timer -= dt;
                if (obj.timer <= 0 && !obj.active) { obj.active = true; obj.timer = 20; shake = 10; }
                if (obj.active) {
                    let d = Math.abs((soul.x - obj.x)*Math.sin(obj.angle) - (soul.y - obj.y)*Math.cos(obj.angle));
                    if (d < 45) { hp -= 2.5 * dt; shake = 3; }
                }
            }
            if (obj.x < -50 || (obj.active && obj.timer < -30)) objects.splice(i, 1);
        });
    }
    if (hp <= 0) { hp = 0; isGameOver = true; }
    document.getElementById('hp-fill').style.width = hp + "%";
    document.getElementById('hp-text').innerText = Math.ceil(hp) + "/100";
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    if (shake > 0) ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2);

    // 1. サンズの描画 (常に中央上部)
    const sansX = 320, sansY = 100;
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.ellipse(sansX, sansY, 40, 35, 0, 0, Math.PI*2); ctx.fill(); // 頭
    ctx.fillStyle = 'black';
    ctx.beginPath(); ctx.arc(sansX-15, sansY-5, 8, 0, Math.PI*2); ctx.fill(); // 目
    ctx.beginPath(); ctx.arc(sansX+15, sansY-5, 8, 0, Math.PI*2); ctx.fill();
    if (phase === 'ATTACK') {
        ctx.fillStyle = (Math.floor(performance.now()/100)%2===0) ? '#0ff' : '#ff0';
        ctx.beginPath(); ctx.arc(sansX+15, sansY-5, 6, 0, Math.PI*2); ctx.fill();
    }

    // 2. 戦闘枠の描画
    ctx.strokeStyle = 'white'; ctx.lineWidth = 5;
    ctx.strokeRect(box.x, box.y, box.w, box.h);

    // 3. 攻撃オブジェクトの描画
    objects.forEach(obj => {
        if (obj.type === 'BONE') {
            ctx.fillStyle = 'white'; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
        } else if (obj.type === 'BLASTER') {
            ctx.save(); ctx.translate(obj.x, obj.y); ctx.rotate(obj.angle);
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.moveTo(-30, -25); ctx.lineTo(40, 0); ctx.lineTo(-30, 25); ctx.fill();
            if (obj.active) {
                ctx.shadowBlur = 20; ctx.shadowColor = 'white';
                ctx.fillRect(0, -35, 800, 70);
            } else {
                ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.strokeRect(0, -30, 800, 60);
            }
            ctx.restore();
        }
    });

    // 4. ソウルの描画
    if (phase === 'ATTACK') {
        ctx.fillStyle = (soul.mode === 'RED' ? '#f00' : '#4af');
        ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
        ctx.beginPath();
        ctx.moveTo(soul.x, soul.y + 12);
        ctx.lineTo(soul.x - 12, soul.y - 10);
        ctx.lineTo(soul.x + 12, soul.y - 10);
        ctx.fill();
    } else if (!isGameOver) {
        ctx.fillStyle = 'white'; ctx.font = '22px DotGothic16'; ctx.textAlign = 'left';
        ctx.fillText("* 準備はいいか？", box.x + 30, box.y + 60);
    }

    ctx.restore();

    // 5. ゲームオーバー表示
    if (isGameOver) {
        ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'red'; ctx.font = '50px DotGothic16'; ctx.textAlign = 'center';
        ctx.fillText('GAME OVER', 320, 240);
        ctx.fillStyle = 'white'; ctx.font = '20px DotGothic16';
        ctx.fillText('タップしてリトライ', 320, 300);
    }
}

function loop() {
    let now = performance.now();
    update((now - lastTime) / 16.6);
    draw();
    lastTime = now;
    requestAnimationFrame(loop);
}

initGame();
loop();
</script>
</body>
</html>
