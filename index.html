<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã“ã„ãƒ•ãƒ©å¨¯æ¥½å±‹ - AUTO LOGIN</title>
    <style>
        :root { --gold: #ffd700; --numa: #39ff14; --pink: #ff007f; --bg: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { padding: 8px 15px; background: #000; border-bottom: 2px solid var(--numa); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        #display-name { color: var(--numa); font-weight: bold; font-size: 16px; }
        .currency { font-weight: bold; font-size: 16px; color: var(--gold); }

        #view { flex: 1; position: relative; width: 100%; overflow: hidden; }
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; }
        .screen.active { display: flex; }

        .btn { padding: 10px; border-radius: 8px; border: none; background: #333; color: white; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--numa); color: #000; width: 95%; margin-top: 10px; }
        input { background: #111; color: white; border: 1px solid #333; padding: 8px; border-radius: 6px; font-size: 14px; }

        /* ã‚¯ãƒ¬ãƒ¼ãƒ³ & ã‚²ãƒ¼ãƒ  */
        #machine { width: 95vw; height: 300px; max-width: 400px; background: #222; border: 4px solid #444; position: relative; overflow: hidden; border-radius: 15px; }
        #hole { position: absolute; left: 0; bottom: 0; width: 60px; height: 35px; background: #000; z-index: 5; }
        #unit { position: absolute; top: 0; width: 50px; display:flex; flex-direction:column; align-items:center; z-index:10; }
        #wire { width: 4px; height: 30px; background: #aaa; }
        #claw { width: 50px; height: 15px; background: var(--pink); position: relative; border-radius: 5px; }
        .arm { width: 8px; height: 30px; background: #eee; position: absolute; top: 10px; transition: 0.3s; transform-origin: top; }
        .arm.L { left: 5px; transform: rotate(40deg); } .arm.R { right: 5px; transform: rotate(-40deg); }
        .pz { position: absolute; bottom: 10px; font-size: 25px; width: 30px; text-align: center; z-index: 8; }
        #track { width: 100%; height: 180px; background: #1a4a1a; position: relative; overflow: hidden; border: 3px solid #000; border-radius: 10px; }
        .horse { position: absolute; left: 10px; font-size: 28px; }

        /* ãƒãƒ£ãƒƒãƒˆï¼ˆç©ºç™½ãªã—ï¼‰ */
        #scr-chat { padding: 0 !important; }
        #chat-box { flex: 1; background: #000; overflow-y: auto; padding: 10px; font-size: 14px; width: 100%; }
        #chat-box div { margin-bottom: 2px; border-bottom: 1px solid #111; padding-bottom: 2px; width: 100%; }
        .chat-controls { background: #111; padding: 8px; border-top: 1px solid #333; width: 100%; }
        .input-group { display: flex; gap: 5px; margin-bottom: 8px; }
        .remit-group { display: flex; gap: 5px; background: #1a1a1a; padding: 8px; border-radius: 8px; border-left: 3px solid var(--numa); }
        .remit-group label { font-size: 10px; color: var(--numa); display: block; margin-bottom: 2px; }

        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; width: 100%; padding: 10px; margin-bottom: 8px; }
        .admin-box { width: 100%; background: #200; border: 1px dashed #f00; padding: 10px; border-radius: 10px; margin-top: 10px; display: none; }

        nav { display: flex; background: #000; border-top: 2px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; background: none; border: none; color: #666; font-size: 9px; padding: 8px 0; }
        .nav-btn.active { color: var(--numa); }
        .nav-btn span { font-size: 18px; display: block; }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 50000; display: none; align-items: center; justify-content: center; }
        #toast { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: var(--numa); color: #000; padding: 8px 16px; border-radius: 50px; display: none; z-index: 60000; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div id="display-name">---</div>
    <div class="currency">ğŸª™ <span id="c-v">0</span></div>
</header>

<div id="view">
    <div id="scr-pachi" class="screen active">
        <canvas id="p-cvs" width="350" height="380" style="background:#000; border-radius:15px; border:2px solid #333;"></canvas>
        <button class="btn btn-main" onclick="shootPachi()">æ‰“ã¡å‡ºã— (5æš)</button>
    </div>
    <div id="scr-crane" class="screen">
        <div id="machine"><div id="hole"></div><div id="unit" style="left:150px;"><div id="wire"></div><div id="claw"><div class="arm L" id="armL"></div><div class="arm R" id="armR"></div></div></div><div id="p-con"></div></div>
        <div style="display:flex; gap:10px; margin-top:10px; width:95%;">
            <button class="btn" style="width:50px; background:#444;" onmousedown="mvL=1" onmouseup="mvL=0" ontouchstart="mvL=1" ontouchend="mvL=0">â—€</button>
            <button class="btn btn-main" onclick="playCrane()" style="flex:1; margin:0;">CATCH (50)</button>
            <button class="btn" style="width:50px; background:#444;" onmousedown="mvR=1" onmouseup="mvR=0" ontouchstart="mvR=1" ontouchend="mvR=0">â–¶</button>
        </div>
    </div>
    <div id="scr-race" class="screen">
        <div id="track"><div id="h1" class="horse" style="top:10px;">ğŸ´</div><div id="h2" class="horse" style="top:50px;">ğŸ¦„</div><div id="h3" class="horse" style="top:90px;">ğŸº</div><div id="h4" class="horse" style="top:130px;">ğŸ‚</div></div>
        <input id="r-bet-am" type="number" placeholder="è³­ã‘é‡‘" style="width:95%; margin:10px 0;">
        <div style="display:flex; gap:5px; width:95%;">
            <button class="btn" onclick="selH(1)" id="b-btn-1" style="flex:1;">1</button>
            <button class="btn" onclick="selH(2)" id="b-btn-2" style="flex:1;">2</button>
            <button class="btn" onclick="selH(3)" id="b-btn-3" style="flex:1;">3</button>
            <button class="btn" onclick="selH(4)" id="b-btn-4" style="flex:1;">4</button>
        </div>
        <button class="btn btn-main" id="r-go" onclick="startRace()" disabled>ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button>
    </div>
    <div id="scr-shop" class="screen">
        <h3 style="color:var(--gold); margin:5px 0;">ğŸ›’ å¨¯æ¥½å±‹ç®¡ç†</h3>
        <div id="shop-items" style="width:100%;"></div>
        <div class="card">
            <span style="font-size:12px;">ğŸ› ï¸ ã‚¢ã‚¤ãƒ†ãƒ å‡ºå“</span>
            <div style="display:flex; gap:5px; margin-top:5px;"><input id="ex-name" placeholder="å" style="flex:2;"><input id="ex-price" type="number" placeholder="Â¥" style="flex:1;"><button class="btn" onclick="exhibitItem()" style="background:var(--gold); color:#000; padding:5px 10px;">å‡ºå“</button></div>
        </div>
        <div id="inventory" class="card" style="font-size:13px;">ğŸ“¦ æ‰€æŒå“: ãªã—</div>
        <input type="password" id="admin-pw" placeholder="Admin Pass" style="width:100%; margin-top:10px;" oninput="checkAdmin()">
        <div id="admin-panel" class="admin-box">
            <div id="u-list" style="font-size:12px; margin-bottom:10px; background:#000; padding:5px; border-radius:5px;"></div>
            <input type="number" id="add-coin-am" placeholder="æšæ•°" style="width:100%;"><button class="btn" style="background:#f00; width:100%; margin-top:5px;" onclick="adminAddCoin()">ä»˜ä¸/æ²¡å</button>
        </div>
    </div>
    <div id="scr-chat" class="screen">
        <div id="chat-box"></div>
        <div class="chat-controls">
            <div class="input-group"><input id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="flex:1;"><button class="btn" onclick="sendChat()" style="background:var(--numa); color:#000; width:60px;">é€ä¿¡</button></div>
            <div class="remit-group">
                <div style="flex:2;"><label>é€é‡‘ç›¸æ‰‹</label><input id="s-to" placeholder="åå‰" style="width:100%; border:none; background:transparent;"></div>
                <div style="flex:1;"><label>æšæ•°</label><input id="s-am" type="number" placeholder="0" style="width:100%; border:none; background:transparent;"></div>
                <button class="btn" onclick="sendMoney()" style="background:#fff; color:#000; align-self: center; padding:5px 10px;">é€é‡‘</button>
            </div>
        </div>
    </div>
</div>

<nav>
    <button class="nav-btn active" onclick="tab('pachi')"><span>ğŸ°</span>æ²¼</button>
    <button class="nav-btn" onclick="tab('crane')"><span>ğŸ—ï¸</span>ã‚¯ãƒ¬ãƒ¼ãƒ³</button>
    <button class="nav-btn" onclick="tab('race')"><span>ğŸ‡</span>ç«¶é¦¬</button>
    <button class="nav-btn" onclick="tab('shop')"><span>ğŸ›’</span>ç®¡ç†</button>
    <button class="nav-btn" onclick="tab('chat')"><span>ğŸ’¬</span>è«‡è©±</button>
</nav>

<div id="login-screen">
    <div style="text-align:center; padding:25px; background:#111; border:2px solid var(--numa); border-radius:20px; width:85%;">
        <h3 style="color:var(--numa); margin-top:0;">ã“ã„ãƒ•ãƒ©å¨¯æ¥½å±‹</h3>
        <input type="text" id="u-in" placeholder="ãªã¾ãˆã‚’å…¥åŠ›" style="width:100%; text-align:center;"><br>
        <button class="btn btn-main" style="margin-top:15px;" onclick="reg()">å…¥åº—</button>
    </div>
</div>
<div id="toast"></div>

<script>
    const Sys = (() => {
        const KEY = 'koifla_v3_save';
        const LAST_USER_KEY = 'koifla_last_active_user';
        let data = JSON.parse(localStorage.getItem(KEY) || '{"u":{}, "chats":[], "items":[]}');
        if(!data.items.length) data.items = [{n:"ãŠå®ˆã‚Š",p:500},{n:"VIPãƒ‘ã‚¹",p:5000}];
        let cur = null;

        const save = () => { if(cur) data.u[cur.name] = cur; localStorage.setItem(KEY, JSON.stringify(data)); upUI(); renShop(); renUsers(); };
        
        return {
            tryAutoLogin: () => {
                const last = localStorage.getItem(LAST_USER_KEY);
                if(last && data.u[last]) { cur = data.u[last]; return true; }
                return false;
            },
            reg: (n) => { 
                if(!n) return false; 
                if(!data.u[n]) data.u[n] = { name:n, coins:1000, inv:[] }; 
                cur = data.u[n]; 
                localStorage.setItem(LAST_USER_KEY, n);
                save(); 
                return true; 
            },
            getU: () => cur,
            getAllU: () => Object.values(data.u),
            add: (a) => { cur.coins+=Number(a); save(); },
            sub: (a) => { if(cur.coins>=a){ cur.coins-=a; save(); return true; } return false; },
            exhibit: (n, p) => { data.items.push({n, p:parseInt(p)}); save(); },
            buy: (idx) => { const item = data.items[idx]; if(cur.coins>=item.p){ cur.coins-=item.p; cur.inv.push(item.n); save(); return true; } return false; },
            sendMoney: (to, am) => { am=parseInt(am); if(data.u[to]&&cur.name!==to&&am>0&&cur.coins>=am){ cur.coins-=am; data.u[to].coins+=am; save(); return true; } return false; },
            sendChat: (m) => { data.chats.push({n:cur.name, m}); if(data.chats.length>50) data.chats.shift(); save(); renChat(); },
            getChats: () => data.chats,
            getItems: () => data.items
        };
    })();

    const $ = id => document.getElementById(id);
    let u=null, mvL=0, mvR=0, cX=150, busy=false, bHorse=0;

    function upUI() { if(!u) return; $('c-v').innerText=Math.floor(u.coins); $('display-name').innerText=u.name; }
    
    function startApp() {
        u = Sys.getU();
        $('login-screen').style.display = 'none';
        spwP(); loop(); renShop(); upUI(); renChat();
    }

    function reg() { 
        const n=$('u-in').value.trim(); 
        if(n && Sys.reg(n)){ startApp(); } 
    }

    function checkAdmin() { if($('admin-pw').value === "010122") { $('admin-panel').style.display = "block"; renUsers(); } }
    function adminAddCoin() { const am = parseInt($('add-coin-am').value); if(am) { Sys.add(am); toast("å®Œäº†"); } }
    function renUsers() { $('u-list').innerHTML = "ğŸ‘¥:<br>" + Sys.getAllU().map(user => `${user.name}(ğŸª™${Math.floor(user.coins)})`).join(' / '); }
    function renShop() { 
        $('shop-items').innerHTML = Sys.getItems().map((i, idx) => `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><div><b>${i.n}</b> <small>ğŸª™${i.p}</small></div><button class="btn" style="padding:4px 10px;" onclick="buyI(${idx})">è²·</button></div>`).join('');
        if(u) $('inventory').innerText = "ğŸ“¦ æ‰€æŒ: " + (u.inv.length ? u.inv.join(', ') : "ãªã—");
    }
    function exhibitItem() { const n=$('ex-name').value, p=$('ex-price').value; if(n && p){ Sys.exhibit(n, p); $('ex-name').value=''; $('ex-price').value=''; toast("å‡ºå“å®Œäº†"); } }
    function buyI(idx) { if(Sys.buy(idx)) toast("è³¼å…¥å®Œäº†"); else toast("ä¸è¶³"); }

    // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
    const cvs=$('p-cvs'), ctx=cvs.getContext('2d');
    let balls=[], pins=[]; for(let r=0; r<10; r++) for(let c=0; c<8; c++) pins.push({x:35+c*40+(r%2)*20, y:40+r*35});
    function drawP(){ ctx.clearRect(0,0,350,380); ctx.fillStyle='#444'; pins.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,7);ctx.fill();}); balls.forEach((b,i)=>{ b.y+=b.vy; b.vy+=0.25; b.x+=b.vx; pins.forEach(p=>{ if(Math.hypot(b.x-p.x,b.y-p.y)<12){ b.vx=(b.x-p.x)*0.6; b.vy*=-0.4; }}); if(b.y>350 && b.x>140 && b.x<210){ Sys.add(40); balls.splice(i,1); toast("WIN! +40"); } else if(b.y>390) balls.splice(i,1); ctx.fillStyle='#39ff14'; ctx.beginPath(); ctx.arc(b.x,b.y,6,0,7); ctx.fill(); }); }
    function shootPachi(){ if(Sys.sub(5)) balls.push({x:175, y:20, vx:Math.random()-0.5, vy:2}); }
    function selH(n){ bHorse=n; for(let i=1;i<=4;i++) $('b-btn-'+i).style.background=(i==n)?'var(--pink)':'#333'; $('r-go').disabled=false; }
    function startRace(){ const am = parseInt($('r-bet-am').value); if(!am || am <= 0 || !Sys.sub(am)) return; busy = true; $('r-go').disabled = true; let pos = [10,10,10,10,10]; let iv = setInterval(() => { for(let i=1; i<=4; i++){ pos[i] += Math.random() * 8; $(`h${i}`).style.left = pos[i] + "%"; if(pos[i] >= 88){ clearInterval(iv); if(i === bHorse){ Sys.add(am * 2); toast("çš„ä¸­ï¼"); } else toast(i+"ç•ªå‹åˆ©"); setTimeout(() => { for(let j=1; j<=4; j++) $(`h${j}`).style.left = "10px"; busy = false; }, 1500); break; } } }, 50); }
    async function playCrane(){
        if(busy || !Sys.sub(50)) return; busy=true;
        const w=$('wire'), aL=$('armL'), aR=$('armR'), ut=$('unit'); let hit=null;
        await moveW(w, 30, 260, 4); aL.style.transform='rotate(-5deg)'; aR.style.transform='rotate(5deg)';
        document.querySelectorAll('.pz').forEach(p=>{ if(Math.abs(parseInt(p.style.left)-cX-10)<18) hit=p; });
        await new Promise(r=>setTimeout(r,500));
        let failAt = Math.random() < 0.4 ? Math.floor(Math.random()*150 + 80) : -1;
        await new Promise(r=>{ let s=260; function up(){ s-=4; w.style.height=s+"px"; if(hit){ hit.style.bottom = (300-s-25)+"px"; if(failAt!==-1 && s<failAt){ aL.style.transform='rotate(40deg)'; aR.style.transform='rotate(-40deg)'; hit.style.bottom="10px"; hit=null; } } if(s>30) requestAnimationFrame(up); else r(); } up(); });
        if(hit){ ut.style.transition="left 1s"; cX=5; ut.style.left="5px"; let mvI = setInterval(()=>{ if(hit) hit.style.left=(ut.offsetLeft+10)+"px"; },20); await new Promise(r=>setTimeout(r,1000)); clearInterval(mvI); aL.style.transform='rotate(40deg)'; aR.style.transform='rotate(-40deg)'; hit.style.bottom="-60px"; await new Promise(r=>setTimeout(r,600)); hit.remove(); Sys.add(250); toast("GET! +250"); spwP(); } else { ut.style.transition="left 0.5s"; cX=5; ut.style.left="5px"; await new Promise(r=>setTimeout(r,500)); }
        ut.style.transition="none"; busy=false;
    }

    function sendChat(){ const i=$('chat-in'); if(i.value){ Sys.sendChat(i.value); i.value=""; } }
    function renChat(){ $('chat-box').innerHTML=Sys.getChats().map(c=>`<div><b>${c.n}:</b> ${c.m}</div>`).join(''); $('chat-box').scrollTop=$('chat-box').scrollHeight; }
    function sendMoney(){ if(Sys.sendMoney($('s-to').value, $('s-am').value)) { toast("é€é‡‘å®Œäº†"); $('s-to').value=''; $('s-am').value=''; } else toast("å¤±æ•—"); }
    function moveW(el,s,e,st){ return new Promise(r=>{ function f(){ s+=st; el.style.height=s+"px"; if((st>0&&s<e)||(st<0&&s>e)) requestAnimationFrame(f); else r();} f();}); }
    function spwP(){ if($('p-con').children.length==0) for(let i=0;i<4;i++) $('p-con').innerHTML+=`<div class="pz" style="left:${80+i*70}px; bottom:10px;">ğŸ</div>`; }
    function tab(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $('scr-'+id).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); event.currentTarget.classList.add('active'); if(id==='chat') renChat(); }
    function toast(m){ const t=$('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }
    function loop() { if(!busy && $('scr-crane').classList.contains('active')) { if(mvL) cX=Math.max(5,cX-4); if(mvR) cX=Math.min(310,cX+4); $('unit').style.left=cX+"px"; } drawP(); requestAnimationFrame(loop); }
    
    // èµ·å‹•å‡¦ç†
    window.onload = () => {
        if(Sys.tryAutoLogin()) {
            startApp();
            toast("ãŠã‹ãˆã‚Šãªã•ã„ï¼");
        } else {
            $('login-screen').style.display = 'flex';
        }
        renShop();
        renChat();
    };
</script>
</body>
</html>
